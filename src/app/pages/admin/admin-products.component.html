<div class="container">
  <div class="products-container">
    <div class="page-header">
      <h1>Product Management</h1>
      <p>
        Manage all products, add new ones, and control their display on gift
        and menu pages
      </p>
    </div>
    <hr />

    <!-- Search & Filter & Add Button -->
    <div class="search-filter-container d-flex flex-wrap gap-3 mb-4 align-items-center">
      <div class="search-input position-relative flex-grow-1">
        <i class="fas fa-search search-icon position-absolute"
           style="top: 50%; left: 15px; transform: translateY(-50%)"></i>
        <input
          type="text"
          class="form-control ps-5"
          placeholder="Search products by name..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="applyFilters()"
        />
      </div>

      <div class="filter-dropdown d-flex align-items-center gap-2">
        <i class="fas fa-filter text-muted"></i>
        <select
          class="form-select"
          [(ngModel)]="categoryFilter"
          (ngModelChange)="applyFilters()"
        >
          <option value="All Categories">All Categories</option>
          <option value="Drinks">Drinks</option>
          <option value="Food">Food</option>
          <option value="Gifts">Gifts</option>
        </select>
      </div>

      <button
        class="btn btn-success add-product-btn fw-bold"
        style="width: 25%"
        (click)="openAddModal()"
      >
        <i class="fas fa-plus me-2"></i>
        Add Product
      </button>
    </div>

    <!-- Error Alert -->
    <div *ngIf="error" class="alert alert-danger" role="alert">
      {{error}}
    </div>

    <!-- Products Grid -->
    <div *ngIf="!error" class="products-grid-container">
      <!-- Products Grid -->
      <div *ngIf="filteredProducts.length > 0" class="products-grid">
        <div *ngFor="let product of filteredProducts" class="product-card">
          <!-- Product Image -->
          <div class="product-card-image">
            <img
              [src]="product.image"
              [alt]="product.name"
              [ngClass]="{
                'img-food-drink': product.category === 'Food' || product.category === 'Drinks',
                'img-gift': product.category === 'Gifts'
              }"
              (error)="$any($event.target).src = 'https://via.placeholder.com/300x200?text=No+Image'"
            />
            <div class="product-card-overlay">
              <span *ngIf="product.featured" class="featured-badge">
                <i class="fas fa-star"></i> Featured
              </span>
            </div>
          </div>

          <!-- Product Content -->
          <div class="product-card-content">
            <div class="product-card-header">
              <h3 class="product-name">
                {{product.name}}
              </h3>
              <div class="price-amount">₹{{product.price}}</div>
            </div>

            <p class="product-description">
              {{ product.description.length > 80 ? (product.description | slice:0:80) + '...' : product.description }}
            </p>

            <!-- Category Badge -->
            <div class="product-category-section">
              <span class="category-badge">{{product.category}}</span>
            </div>

            <!-- Status Section -->
            <div class="product-card-status">
              <button
                class="btn btn-sm fw-bold status-btn"
                [ngClass]="product.isAvailable ? 'btn-success' : 'btn-secondary'"
                (click)="handleToggleAvailability(product._id)"
                [title]="product.isAvailable ? 'Click to deactivate' : 'Click to activate'"
              >
                <ng-container *ngIf="product.isAvailable; else inactive">
                  <i class="fas fa-check-circle me-2"></i> <span>Active</span>
                </ng-container>
                <ng-template #inactive>
                  <i class="fas fa-times-circle me-2"></i> <span>Inactive</span>
                </ng-template>
              </button>
            </div>

            <!-- Display Options -->
            <div class="product-card-display-options">
              <span class="display-label">Display:</span>
              <div class="display-options">
                <button
                  class="btn btn-sm"
                  [ngClass]="product.displayOnGift ? 'btn-info' : 'btn-outline-info'"
                  (click)="handleToggleDisplay(product._id, 'gift')"
                  [title]="product.displayOnGift ? 'Remove from Gift page' : 'Add to Gift page'"
                >
                  <i class="fas fa-gift me-1"></i> Gift
                </button>
                <button
                  class="btn btn-sm"
                  [ngClass]="product.displayOnMenu ? 'btn-warning' : 'btn-outline-warning'"
                  (click)="handleToggleDisplay(product._id, 'menu')"
                  [title]="product.displayOnMenu ? 'Remove from Menu page' : 'Add to Menu page'"
                >
                  <i class="fas fa-bars me-1"></i> Menu
                </button>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="product-card-actions">
              <button
                class="btn btn-sm btn-outline-primary action-btn"
                (click)="openEditModal(product)"
                title="Edit product"
              >
                <i class="fas fa-edit me-1"></i> Edit
              </button>
              <button
                class="btn btn-sm btn-outline-danger action-btn"
                (click)="handleDeleteProduct(product._id)"
                title="Delete product"
              >
                <i class="fas fa-trash me-1"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredProducts.length === 0" class="empty-state">
        <i class="fas fa-box fa-3x text-muted mb-3"></i>
        <h5>No products found</h5>
        <p class="mb-0">
          {{ searchTerm || categoryFilter !== 'All Categories' ? 'Try adjusting your search or filter criteria' : 'Get started by adding your first product' }}
        </p>
      </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div *ngIf="showAddModal || showEditModal"
         class="modal show d-block"
         style="background-color: rgba(0,0,0,0.5)">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="fas" [ngClass]="showAddModal ? 'fa-plus' : 'fa-edit'"></i>
              {{ showAddModal ? 'Add New Product' : 'Edit Product: ' + selectedProduct?.name }}
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="closeModals()"></button>
          </div>
          <form (ngSubmit)="showAddModal ? handleAddProduct() : handleEditProduct()">
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Product Name *</label>
                  <input
                    type="text"
                    class="form-control"
                    name="name"
                    [(ngModel)]="formData.name"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Category *</label>
                  <select
                    class="form-select"
                    name="category"
                    [(ngModel)]="formData.category"
                    required
                  >
                    <option value="Drinks">Drinks</option>
                    <option value="Food">Food</option>
                    <option value="Gifts">Gifts</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Description *</label>
                <textarea
                  class="form-control"
                  name="description"
                  rows="3"
                  style="resize: none; height: 80px"
                  [(ngModel)]="formData.description"
                  required
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Price (₹) *</label>
                  <input
                    type="number"
                    class="form-control"
                    name="price"
                    [(ngModel)]="formData.price"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Image URL *</label>
                  <input
                    type="url"
                    class="form-control"
                    name="image"
                    [(ngModel)]="formData.image"
                    (ngModelChange)="onImageChange()"
                    placeholder="https://example.com/image.jpg"
                    required
                  />
                </div>
              </div>
              
              <!-- Image Preview Section -->
              <div *ngIf="formData.image" class="mb-3">
                <label class="form-label">Image Preview</label>
                <div class="d-flex flex-column align-items-center mt-2">
                  <div *ngIf="imagePreview && !imageError"
                       style="border: 2px solid #00704A; border-radius: 12px; padding: 8px; background: #fafafa; box-shadow: 0 2px 8px rgba(0,0,0,0.07)">
                    <img
                      [src]="imagePreview"
                      alt="Preview"
                      (error)="imageError = 'Invalid image URL or image could not be loaded.'"
                      style="max-width: 220px; max-height: 220px; border-radius: 8px; display: block"
                    />
                  </div>
                  <div *ngIf="imageError" class="text-danger mt-1 small">
                    {{imageError}}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-12 mb-2">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="displayOnGift"
                      [(ngModel)]="formData.displayOnGift"
                    />
                    <label class="form-check-label">Show on Gift Page</label>
                  </div>
                </div>
                <div class="col-md-12 mb-2">
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      name="displayOnMenu"
                      [(ngModel)]="formData.displayOnMenu"
                    />
                    <label class="form-check-label">Show on Menu Page</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary fw-bold w-25"
                (click)="closeModals()"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="btn btn-success fw-bold w-25"
              >
                {{ showAddModal ? 'Add Product' : 'Save Changes' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
